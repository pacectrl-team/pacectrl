<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PaceCtrl Widget Customizer</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f0f2f5;
        color: #1a2e35;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* ------------------------------------------------------------------ */
      /* Left panel – controls                                              */
      /* ------------------------------------------------------------------ */
      .panel {
        width: 380px;
        min-width: 320px;
        height: 100vh;
        overflow-y: auto;
        background: #ffffff;
        border-right: 1px solid #e1e4e8;
        padding: 24px 20px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .panel h1 {
        font-size: 1.15rem;
        margin: 0 0 4px;
      }

      .panel p.subtitle {
        font-size: 0.82rem;
        color: #6b7785;
        margin: 0 0 14px;
        line-height: 1.4;
      }

      /* Collapsible sections */
      details {
        border: 1px solid #e8ebef;
        border-radius: 10px;
        background: #fafbfc;
        overflow: hidden;
      }

      details + details {
        margin-top: 2px;
      }

      summary {
        cursor: pointer;
        padding: 10px 14px;
        font-weight: 600;
        font-size: 0.85rem;
        color: #2c3e50;
        user-select: none;
        list-style: none;
      }

      summary::-webkit-details-marker {
        display: none;
      }

      summary::before {
        content: "▸ ";
        display: inline-block;
        transition: transform 150ms ease;
      }

      details[open] > summary::before {
        transform: rotate(90deg);
      }

      .fields {
        padding: 6px 14px 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* Field rows */
      .field {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .field label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #4a5568;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .field input[type="text"],
      .field input[type="number"],
      .field textarea {
        width: 100%;
        padding: 7px 10px;
        border: 1px solid #d1d5da;
        border-radius: 6px;
        font-size: 0.85rem;
        font-family: inherit;
        background: #fff;
        color: #24292e;
        outline: none;
        transition: border-color 120ms ease;
      }

      .field input:focus,
      .field textarea:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
      }

      .field textarea {
        resize: vertical;
        min-height: 56px;
      }

      /* Colour picker row */
      .color-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .color-row input[type="color"] {
        width: 32px;
        height: 32px;
        border: 1px solid #d1d5da;
        border-radius: 6px;
        padding: 2px;
        cursor: pointer;
        background: #fff;
      }

      .color-row input[type="text"] {
        flex: 1;
      }

      /* JSON export area */
      .json-section {
        margin-top: auto;
        padding-top: 10px;
      }

      .json-section summary {
        font-size: 0.8rem;
      }

      #json-output {
        width: 100%;
        min-height: 120px;
        font-family: "Fira Code", "Cascadia Code", "Consolas", monospace;
        font-size: 0.72rem;
        border: 1px solid #d1d5da;
        border-radius: 6px;
        padding: 8px;
        background: #f6f8fa;
        color: #24292e;
        resize: vertical;
        white-space: pre;
        tab-size: 2;
      }

      .copy-btn {
        margin-top: 6px;
        padding: 6px 14px;
        font-size: 0.78rem;
        font-weight: 600;
        border: 1px solid #d1d5da;
        border-radius: 6px;
        background: #fff;
        color: #24292e;
        cursor: pointer;
        transition: background 120ms ease;
      }

      .copy-btn:hover {
        background: #f3f4f6;
      }

      /* ------------------------------------------------------------------ */
      /* Right side – preview                                               */
      /* ------------------------------------------------------------------ */
      .preview {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        overflow: auto;
        background:
          radial-gradient(circle at top, rgba(54, 133, 107, 0.12), transparent 55%),
          radial-gradient(circle at bottom, rgba(197, 71, 54, 0.08), transparent 60%),
          #f0f2f5;
      }

      #widget-host {
        width: 100%;
        max-width: 700px;
        display: flex;
        justify-content: center;
      }
    </style>
  </head>

  <body>
    <!-- ================================================================ -->
    <!-- Controls panel                                                    -->
    <!-- ================================================================ -->
    <aside class="panel">
      <h1>Widget Customizer</h1>
      <p class="subtitle">
        Tweak every theme property and see the widget update in real time.
        No data is saved — this is a local playground only.
      </p>

      <!-- Colours -->
      <details open>
        <summary>Colours</summary>
        <div class="fields">
          <div class="field" data-key="slider_slow_color">
            <label>Slider Slow Colour</label>
            <div class="color-row">
              <input type="color" value="#0f9d58" />
              <input type="text" value="#0f9d58" />
            </div>
          </div>
          <div class="field" data-key="slider_fast_color">
            <label>Slider Fast Colour</label>
            <div class="color-row">
              <input type="color" value="#c0392b" />
              <input type="text" value="#c0392b" />
            </div>
          </div>
          <div class="field" data-key="background_hue_slow_color">
            <label>Background Hue (Slow)</label>
            <div class="color-row">
              <input type="color" value="#c8f7d8" />
              <input type="text" value="hsl(140, 82%, 92%)" />
            </div>
          </div>
          <div class="field" data-key="background_hue_fast_color">
            <label>Background Hue (Fast)</label>
            <div class="color-row">
              <input type="color" value="#fad4d4" />
              <input type="text" value="hsl(0, 82%, 92%)" />
            </div>
          </div>
          <div class="field" data-key="font_color">
            <label>Font Colour</label>
            <div class="color-row">
              <input type="color" value="#0b1f29" />
              <input type="text" value="#0b1f29" />
            </div>
          </div>
          <div class="field" data-key="background_color">
            <label>Background Colour</label>
            <div class="color-row">
              <input type="color" value="#ffffff" />
              <input type="text" value="#ffffff" />
            </div>
          </div>
          <div class="field" data-key="border_color">
            <label>Border Colour</label>
            <div class="color-row">
              <input type="color" value="#1e3b2e" />
              <input type="text" value="rgba(12, 59, 46, 0.12)" />
            </div>
          </div>
          <div class="field" data-key="slider_dot_color">
            <label>Slider Dot Colour</label>
            <div class="color-row">
              <input type="color" value="#0f9d58" />
              <input type="text" value="" />
            </div>
          </div>
        </div>
      </details>

      <!-- Typography -->
      <details open>
        <summary>Typography</summary>
        <div class="fields">
          <div class="field" data-key="font_family">
            <label>Font Family</label>
            <input type="text" value="Inter, system-ui, sans-serif" />
          </div>
          <div class="field" data-key="font_size">
            <label>Base Font Size (px)</label>
            <input type="number" value="16" min="8" max="40" step="1" />
          </div>
        </div>
      </details>

      <!-- Layout -->
      <details open>
        <summary>Layout</summary>
        <div class="fields">
          <div class="field" data-key="border_width">
            <label>Border Width (px)</label>
            <input type="number" value="1" min="0" max="20" step="1" />
          </div>
          <div class="field" data-key="rounding_px">
            <label>Corner Rounding (px)</label>
            <input type="number" value="24" min="0" max="60" step="1" />
          </div>
          <div class="field" data-key="widget_width">
            <label>Widget Width (CSS value)</label>
            <input type="text" value="" placeholder="e.g. 520px or 100%" />
          </div>
        </div>
      </details>

      <!-- Labels -->
      <details>
        <summary>Labels &amp; Text</summary>
        <div class="fields">
          <div class="field" data-key="slider_label">
            <label>Slider Label</label>
            <input type="text" value="Vote on the trip speed" />
          </div>
          <div class="field" data-key="scale_label_slow">
            <label>Scale Label (Slow)</label>
            <input type="text" value="Calmer seas" />
          </div>
          <div class="field" data-key="scale_label_fast">
            <label>Scale Label (Fast)</label>
            <input type="text" value="Arrive sooner" />
          </div>
          <div class="field" data-key="mood_slow_text">
            <label>Mood — Slow</label>
            <input type="text" value="Plenty of time" />
          </div>
          <div class="field" data-key="mood_standard_text">
            <label>Mood — Standard</label>
            <input type="text" value="Balanced" />
          </div>
          <div class="field" data-key="mood_fast_text">
            <label>Mood — Fast</label>
            <input type="text" value="Racing" />
          </div>
          <div class="field" data-key="info_text">
            <label>Info Panel Text</label>
            <textarea>Drag the slider to vote on how fast the ferry should sail. Slower speeds add travel time but cut CO₂ emissions.</textarea>
          </div>
        </div>
      </details>

      <!-- Voyage simulation -->
      <details>
        <summary>Voyage Simulation</summary>
        <div class="fields">
          <div class="field" data-key="default_speed_percentage">
            <label>Default Speed %</label>
            <input type="number" value="50" min="0" max="100" step="1" />
          </div>
          <p style="font-size:0.75rem; color:#6b7785; margin:0; line-height:1.4;">
            These dummy anchors define the slow / standard / fast profiles
            used for the interpolated stats. Edit them to simulate different voyages.
          </p>
          <div class="field" data-key="slow_speed">
            <label>Slow Speed (kn)</label>
            <input type="number" value="8" min="1" max="50" step="0.5" />
          </div>
          <div class="field" data-key="standard_speed">
            <label>Standard Speed (kn)</label>
            <input type="number" value="12" min="1" max="50" step="0.5" />
          </div>
          <div class="field" data-key="fast_speed">
            <label>Fast Speed (kn)</label>
            <input type="number" value="16" min="1" max="50" step="0.5" />
          </div>
          <div class="field" data-key="slow_emissions">
            <label>Slow Emissions (kg CO₂)</label>
            <input type="number" value="80" min="0" max="5000" step="1" />
          </div>
          <div class="field" data-key="standard_emissions">
            <label>Standard Emissions (kg CO₂)</label>
            <input type="number" value="120" min="0" max="5000" step="1" />
          </div>
          <div class="field" data-key="fast_emissions">
            <label>Fast Emissions (kg CO₂)</label>
            <input type="number" value="200" min="0" max="5000" step="1" />
          </div>
          <div class="field" data-key="slow_delay">
            <label>Slow Arrival Delta (min)</label>
            <input type="number" value="25" min="-120" max="120" step="1" />
          </div>
          <div class="field" data-key="standard_delay">
            <label>Standard Arrival Delta (min)</label>
            <input type="number" value="0" min="-120" max="120" step="1" />
          </div>
          <div class="field" data-key="fast_delay">
            <label>Fast Arrival Delta (min)</label>
            <input type="number" value="-10" min="-120" max="120" step="1" />
          </div>
        </div>
      </details>

      <!-- JSON export -->
      <details class="json-section">
        <summary>Export JSON</summary>
        <div class="fields">
          <textarea id="json-output" readonly></textarea>
          <button class="copy-btn" id="copy-btn">Copy to clipboard</button>
        </div>
      </details>
    </aside>

    <!-- ================================================================ -->
    <!-- Preview area                                                      -->
    <!-- ================================================================ -->
    <section class="preview">
      <div id="widget-host">
        <div id="pace-widget" data-external-trip-id="demo" data-public-key="demo"></div>
      </div>
    </section>

    <!-- Load the compiled widget bundle -->
    <script src="https://pacectrl-production.up.railway.app/widget.js"></script>

    <script>
      /* ================================================================
       * Widget Customizer – wires the panel controls to a fake
       * WidgetConfig so the widget renders without any API calls.
       * ============================================================= */

      /* ---------- helpers ------------------------------------------- */
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => [...document.querySelectorAll(sel)];

      /** Read the current value of a field by its data-key. */
      function fieldValue(key) {
        const field = $(`.field[data-key="${key}"]`);
        if (!field) return undefined;

        // Colour fields use the text input (supports any CSS colour string)
        const colorText = field.querySelector(".color-row input[type=text]");
        if (colorText) return colorText.value;

        const input = field.querySelector("input, textarea");
        if (!input) return undefined;
        if (input.type === "number") return Number(input.value);
        return input.value;
      }

      /* ---------- Build a fake WidgetConfig from current controls --- */
      function buildConfig() {
        return {
          id: 0,
          name: "Customizer Preview",
          description: null,
          default_speed_percentage: fieldValue("default_speed_percentage") ?? 50,
          default_departure_datetime: null,
          default_arrival_datetime: "2026-06-15T14:00:00",
          status: "scheduled",
          derived: {
            min_speed: fieldValue("slow_speed") ?? 8,
            max_speed: fieldValue("fast_speed") ?? 16,
          },
          theme: {
            slider_slow_color: fieldValue("slider_slow_color"),
            slider_fast_color: fieldValue("slider_fast_color"),
            background_hue_slow_color: fieldValue("background_hue_slow_color"),
            background_hue_fast_color: fieldValue("background_hue_fast_color"),
            font_color: fieldValue("font_color"),
            background_color: fieldValue("background_color"),
            border_color: fieldValue("border_color"),
            border_width: fieldValue("border_width"),
            font_size: fieldValue("font_size"),
            font_family: fieldValue("font_family"),
            rounding_px: fieldValue("rounding_px"),
            slider_dot_color: fieldValue("slider_dot_color"),
            slider_label: fieldValue("slider_label"),
            scale_label_slow: fieldValue("scale_label_slow"),
            scale_label_fast: fieldValue("scale_label_fast"),
            info_text: fieldValue("info_text"),
            mood_slow_text: fieldValue("mood_slow_text"),
            mood_standard_text: fieldValue("mood_standard_text"),
            mood_fast_text: fieldValue("mood_fast_text"),
            widget_width: fieldValue("widget_width"),
          },
          anchors: {
            slow: {
              profile: "slow",
              speed_knots: fieldValue("slow_speed") ?? 8,
              expected_emissions_kg_co2: fieldValue("slow_emissions") ?? 80,
              expected_arrival_delta_minutes: fieldValue("slow_delay") ?? 25,
            },
            standard: {
              profile: "standard",
              speed_knots: fieldValue("standard_speed") ?? 12,
              expected_emissions_kg_co2: fieldValue("standard_emissions") ?? 120,
              expected_arrival_delta_minutes: fieldValue("standard_delay") ?? 0,
            },
            fast: {
              profile: "fast",
              speed_knots: fieldValue("fast_speed") ?? 16,
              expected_emissions_kg_co2: fieldValue("fast_emissions") ?? 200,
              expected_arrival_delta_minutes: fieldValue("fast_delay") ?? -10,
            },
          },
        };
      }

      /** Build the exportable JSON object (matches the widget-config schema). */
      function buildExportJson() {
        const cfg = buildConfig();
        return {
          name: "Custom Theme",
          description: "",
          config: {
            default_speed_percentage: cfg.default_speed_percentage,
            theme: cfg.theme,
          },
          is_active: true,
        };
      }

      /* ---------- Intercept fetch so the widget never hits the API --- */
      const _realFetch = window.fetch;
      window.fetch = function (url, opts) {
        if (typeof url === "string" && url.includes("/api/v1/public/widget/config")) {
          // Return a fake Response with the current config
          return Promise.resolve(
            new Response(JSON.stringify(buildConfig()), {
              status: 200,
              headers: { "Content-Type": "application/json" },
            })
          );
        }
        if (typeof url === "string" && url.includes("/api/v1/public/choice-intents")) {
          // Swallow intent POSTs — return a dummy response
          return Promise.resolve(
            new Response(
              JSON.stringify({
                intent_id: "00000000-0000-0000-0000-000000000000",
                voyage_id: 0,
                slider_value: 0.5,
                delta_pct_from_standard: 0,
                selected_speed_kn: null,
                created_at: new Date().toISOString(),
                expires_at: new Date(Date.now() + 900_000).toISOString(),
              }),
              { status: 201, headers: { "Content-Type": "application/json" } }
            )
          );
        }
        return _realFetch.call(this, url, opts);
      };

      /* ---------- (Re-)mount the widget ----------------------------- */
      let currentDestroy = null;

      async function mountWidget() {
        // Tear down previous instance
        if (currentDestroy) {
          currentDestroy();
          currentDestroy = null;
        }
        const host = $("#pace-widget");
        host.innerHTML = "";

        const result = await window.PaceCtrlWidget.init({
          container: "#pace-widget",
          onIntentCreated() {},
        });
        currentDestroy = result.destroy;
      }

      /* ---------- Sync colour picker <-> text input ----------------- */
      function syncColourInputs() {
        $$(".color-row").forEach((row) => {
          const picker = row.querySelector("input[type=color]");
          const text = row.querySelector("input[type=text]");

          picker.addEventListener("input", () => {
            text.value = picker.value;
            scheduleRemount();
          });

          text.addEventListener("input", () => {
            // Only update picker if it looks like a valid hex colour
            if (/^#[0-9a-f]{6}$/i.test(text.value.trim())) {
              picker.value = text.value.trim();
            }
            scheduleRemount();
          });
        });
      }

      /* ---------- Wire up all inputs -------------------------------- */
      let remountTimer = null;

      function scheduleRemount() {
        // Update JSON output immediately
        updateJsonOutput();
        // Debounce widget re-mount for smooth typing
        clearTimeout(remountTimer);
        remountTimer = setTimeout(() => mountWidget(), 250);
      }

      function updateJsonOutput() {
        const el = $("#json-output");
        if (el) {
          el.value = JSON.stringify(buildExportJson(), null, 2);
        }
      }

      function wireInputs() {
        syncColourInputs();
        // All non-colour inputs
        $$(".field input:not([type=color]), .field textarea").forEach((input) => {
          // Skip colour text inputs (already handled)
          if (input.closest(".color-row")) return;
          input.addEventListener("input", scheduleRemount);
        });
      }

      /* ---------- Copy button --------------------------------------- */
      $("#copy-btn").addEventListener("click", () => {
        const text = $("#json-output").value;
        navigator.clipboard.writeText(text).then(() => {
          const btn = $("#copy-btn");
          btn.textContent = "Copied!";
          setTimeout(() => (btn.textContent = "Copy to clipboard"), 1500);
        });
      });

      /* ---------- Boot --------------------------------------------- */
      wireInputs();
      updateJsonOutput();
      mountWidget();
    </script>
  </body>
</html>
